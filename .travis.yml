language: elixir
elixir: '1.5.1'
otp_release: '20.0'

sudo: required

addons:
  postgresql: '9.6'
  apt:
    sources:
      - google-chrome
    packages:
      - google-chrome-stable

# Do not build all tags pushed by Travis
branches:
  except:
    - /^v?\d+\.\d+\.\d+$/

before_install:
  # Get version number from package.json and the git tag (controlled by Travis)
  # If major and minor of the git tag match package.json version, ++ the patch #
  # else, dev has manually updated major or minor and patch needs to reset to 0
  - "{ sed -nE 's/^[ \\t]*\"version\": \"([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}\",$/\\1/p' package.json;
      git describe --abbrev=0 | sed -E 's/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1 \\2/g'; }
    | tr \"\\n\" \" \"
    | awk '{printf($1==$2?\"v\"$2$3+1:\"v\"$1\"0\")}'
    | xargs -I {} git tag -a {} -m \"{}\"\n"
  - npm --no-git-tag-version version from-git

  # Backend
  - cd backend/
  # setting the path for phantom.js 2.0.0
  - export PATH=/usr/local/phantomjs-2.0.0/bin:$PATH

install:
  - mix local.hex --force
  - mix local.rebar --force
  - mix deps.get
  # Frontend
  - cd ../frontend
  - mkdir travis-phantomjs
  - wget https://s3.amazonaws.com/travis-phantomjs/phantomjs-2.0.0-ubuntu-12.04.tar.bz2 -O $PWD/travis-phantomjs/phantomjs-2.0.0-ubuntu-12.04.tar.bz2
  - tar -xvf $PWD/travis-phantomjs/phantomjs-2.0.0-ubuntu-12.04.tar.bz2 -C $PWD/travis-phantomjs
  - export PATH=$PWD/travis-phantomjs:$PATH
  - yarn global add bower
  - yarn install
  - npm install -g ember-cli
  - bower install

before_script:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start
  # Backend
  - cd ../backend
  - cp config/travis.exs config/test.exs
  - mix do ecto.create, ecto.migrate

script:
  - mix test
  # Frontend
  - cd ../frontend
  - ember test

deploy:
  provider: script
  skip_cleanup: true
  script: git push --tags
  on:
    branch: master
