language: elixir
elixir: '1.5.1'
otp_release: '20.0'

sudo: required

addons:
  postgresql: '9.6'
  apt:
    sources:
      - google-chrome
    packages:
      - google-chrome-stable

before_install:
  # Backend
  - cd backend/
  # setting the path for phantom.js 2.0.0
  - export PATH=/usr/local/phantomjs-2.0.0/bin:$PATH

install:
  - echo $TRAVIS_OTP_RELEASE
  - mix local.hex --force
  - mix local.rebar --force
  - mix deps.get
  # Frontend
  - cd ../frontend
  - mkdir travis-phantomjs
  - wget https://s3.amazonaws.com/travis-phantomjs/phantomjs-2.0.0-ubuntu-12.04.tar.bz2 -O $PWD/travis-phantomjs/phantomjs-2.0.0-ubuntu-12.04.tar.bz2
  - tar -xvf $PWD/travis-phantomjs/phantomjs-2.0.0-ubuntu-12.04.tar.bz2 -C $PWD/travis-phantomjs
  - export PATH=$PWD/travis-phantomjs:$PATH
  - yarn global add bower
  - yarn install
  - npm install -g ember-cli
  - bower install

before_script:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start
  # Backend
  - cd ../backend
  - cp config/travis.exs config/test.exs
  - mix do ecto.create, ecto.migrate

script:
  - mix test
  # Frontend
  - cd ../frontend
  - ember test

after_success:
  -awk -F'[.]' '{print $1"."$2"."$TRAVIS_BUILD_NUMBER}' version.txt > temp_file && mv temp_file version.txt | cat version.txt
